{"ast":null,"code":"var _env;\n// src/auth.ts\n\n// Позволяваме override през Vite env: VITE_API_BASE=http://127.0.0.1:8000\nconst BASE = ((_env = import.meta.env) === null || _env === void 0 ? void 0 : _env.VITE_API_BASE) || window.__API_BASE__ || 'http://127.0.0.1:8000';\n\n/**\r\n * Отваря попъп директно към бекенда, който връща 302 към Google:\r\n *   GET /auth/login/google?redirect=1\r\n * Callback-ът /auth/callback/google прави postMessage({ user, tokens }).\r\n */\nexport async function openOAuthPopup(provider) {\n  const w = 500,\n    h = 650;\n  const left = window.screenX + (window.outerWidth - w) / 2;\n  const top = window.screenY + (window.outerHeight - h) / 2;\n\n  // ВАЖНО: директно към redirect=1 (без предварителен fetch)\n  const popup = window.open(`${BASE}/auth/login/${provider}?redirect=1`, 'oauth', `width=${w},height=${h},left=${left},top=${top}`);\n  if (!popup) throw new Error('Popup blocked');\n  return new Promise((resolve, reject) => {\n    const timeout = setTimeout(() => {\n      window.removeEventListener('message', onMsg);\n      try {\n        if (popup) popup.close();\n      } catch {}\n      reject(new Error('OAuth timed out'));\n    }, 120000);\n    const tick = setInterval(() => {\n      if (popup.closed) {\n        clearInterval(tick);\n        clearTimeout(timeout);\n        window.removeEventListener('message', onMsg);\n        reject(new Error('Popup closed'));\n      }\n    }, 500);\n    function onMsg(ev) {\n      var _ev$data, _ev$data$tokens;\n      const ok = ev === null || ev === void 0 ? void 0 : (_ev$data = ev.data) === null || _ev$data === void 0 ? void 0 : (_ev$data$tokens = _ev$data.tokens) === null || _ev$data$tokens === void 0 ? void 0 : _ev$data$tokens.access_token;\n      if (!ok) return;\n      clearInterval(tick);\n      clearTimeout(timeout);\n      window.removeEventListener('message', onMsg);\n      try {\n        popup.close();\n      } catch {}\n      resolve(ev.data);\n    }\n    window.addEventListener('message', onMsg);\n  });\n}\nexport async function fetchMe(accessToken) {\n  const res = await fetch(`${BASE}/auth/me`, {\n    headers: {\n      Authorization: `Bearer ${accessToken}`\n    }\n  });\n  if (!res.ok) throw new Error('Invalid token');\n  return res.json();\n}","map":{"version":3,"names":["BASE","_env","import","meta","env","VITE_API_BASE","window","__API_BASE__","openOAuthPopup","provider","w","h","left","screenX","outerWidth","top","screenY","outerHeight","popup","open","Error","Promise","resolve","reject","timeout","setTimeout","removeEventListener","onMsg","close","tick","setInterval","closed","clearInterval","clearTimeout","ev","_ev$data","_ev$data$tokens","ok","data","tokens","access_token","addEventListener","fetchMe","accessToken","res","fetch","headers","Authorization","json"],"sources":["C:/Users/komun/booking-app/frontend/src/auth.ts"],"sourcesContent":["// src/auth.ts\r\nexport type AuthResult = {\r\n  user: { id: number; email: string; name?: string | null; picture?: string | null };\r\n  tokens: { access_token: string; refresh_token: string; token_type: 'bearer' };\r\n};\r\n\r\n// Позволяваме override през Vite env: VITE_API_BASE=http://127.0.0.1:8000\r\nconst BASE =\r\n  (import.meta as any).env?.VITE_API_BASE ||\r\n  (window as any).__API_BASE__ ||\r\n  'http://127.0.0.1:8000';\r\n\r\n/**\r\n * Отваря попъп директно към бекенда, който връща 302 към Google:\r\n *   GET /auth/login/google?redirect=1\r\n * Callback-ът /auth/callback/google прави postMessage({ user, tokens }).\r\n */\r\nexport async function openOAuthPopup(provider: 'google'): Promise<AuthResult> {\r\n  const w = 500, h = 650;\r\n  const left = window.screenX + (window.outerWidth - w) / 2;\r\n  const top = window.screenY + (window.outerHeight - h) / 2;\r\n\r\n  // ВАЖНО: директно към redirect=1 (без предварителен fetch)\r\n  const popup = window.open(\r\n    `${BASE}/auth/login/${provider}?redirect=1`,\r\n    'oauth',\r\n    `width=${w},height=${h},left=${left},top=${top}`\r\n  );\r\n  if (!popup) throw new Error('Popup blocked');\r\n\r\n  return new Promise<AuthResult>((resolve, reject) => {\r\n    const timeout = setTimeout(() => {\r\n      window.removeEventListener('message', onMsg);\r\n      try { if (popup) popup.close(); } catch {}\r\n      reject(new Error('OAuth timed out'));\r\n    }, 120_000);\r\n\r\n    const tick = setInterval(() => {\r\n      if (popup.closed) {\r\n        clearInterval(tick);\r\n        clearTimeout(timeout);\r\n        window.removeEventListener('message', onMsg);\r\n        reject(new Error('Popup closed'));\r\n      }\r\n    }, 500);\r\n\r\n    function onMsg(ev: MessageEvent) {\r\n      const ok = ev?.data?.tokens?.access_token;\r\n      if (!ok) return;\r\n      clearInterval(tick);\r\n      clearTimeout(timeout);\r\n      window.removeEventListener('message', onMsg);\r\n      try { popup.close(); } catch {}\r\n      resolve(ev.data as AuthResult);\r\n    }\r\n\r\n    window.addEventListener('message', onMsg);\r\n  });\r\n}\r\n\r\nexport async function fetchMe(accessToken: string) {\r\n  const res = await fetch(`${BASE}/auth/me`, {\r\n    headers: { Authorization: `Bearer ${accessToken}` },\r\n  });\r\n  if (!res.ok) throw new Error('Invalid token');\r\n  return res.json();\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}