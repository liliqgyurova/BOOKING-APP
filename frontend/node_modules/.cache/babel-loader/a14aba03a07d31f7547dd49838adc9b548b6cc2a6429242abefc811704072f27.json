{"ast":null,"code":"var _env;// src/auth.ts\nconst BASE=((_env=import.meta.env)===null||_env===void 0?void 0:_env.VITE_API_BASE)||window.__API_BASE__||'http://127.0.0.1:8000';// прочети стойност на cookie по име\nfunction getCookie(name){const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-.$?*|{}()[\\]\\\\/+^]/g,'\\\\$&')+'=([^;]*)'));return m?decodeURIComponent(m[1]):null;}export async function openOAuthPopup(provider){const w=500,h=650;const left=window.screenX+(window.outerWidth-w)/2;const top=window.screenY+(window.outerHeight-h)/2;const popup=window.open(`${BASE}/auth/login/${provider}?redirect=1`,'oauth',`width=${w},height=${h},left=${left},top=${top}`);if(!popup)throw new Error('Popup blocked');return new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{window.removeEventListener('message',onMsg);try{if(popup)popup.close();}catch{}reject(new Error('OAuth timed out'));},120000);const tick=setInterval(()=>{if(popup.closed){clearInterval(tick);clearTimeout(timeout);window.removeEventListener('message',onMsg);reject(new Error('Popup closed'));}},500);function onMsg(ev){var _ev$data,_ev$data$user;const ok=ev===null||ev===void 0?void 0:(_ev$data=ev.data)===null||_ev$data===void 0?void 0:(_ev$data$user=_ev$data.user)===null||_ev$data$user===void 0?void 0:_ev$data$user.email;if(!ok)return;clearInterval(tick);clearTimeout(timeout);window.removeEventListener('message',onMsg);try{if(popup)popup.close();}catch{}resolve(ev.data);}window.addEventListener('message',onMsg);});}export async function fetchMe(){const res=await fetch(`${BASE}/auth/me`,{credentials:'include'});if(!res.ok)throw new Error('Invalid session');return res.json();}export async function refreshSession(){const xsrf=getCookie('XSRF-TOKEN');const res=await fetch(`${BASE}/auth/refresh`,{method:'POST',credentials:'include',headers:xsrf?{'X-XSRF-TOKEN':xsrf}:{}});if(!res.ok)throw new Error('Refresh failed');return res.json();}export async function logout(){const xsrf=getCookie('XSRF-TOKEN');const res=await fetch(`${BASE}/auth/logout`,{method:'POST',credentials:'include',headers:xsrf?{'X-XSRF-TOKEN':xsrf}:{}});if(!res.ok)throw new Error('Logout failed');return res.json();}","map":{"version":3,"names":["BASE","_env","import","meta","env","VITE_API_BASE","window","__API_BASE__","getCookie","name","m","document","cookie","match","RegExp","replace","decodeURIComponent","openOAuthPopup","provider","w","h","left","screenX","outerWidth","top","screenY","outerHeight","popup","open","Error","Promise","resolve","reject","timeout","setTimeout","removeEventListener","onMsg","close","tick","setInterval","closed","clearInterval","clearTimeout","ev","_ev$data","_ev$data$user","ok","data","user","email","addEventListener","fetchMe","res","fetch","credentials","json","refreshSession","xsrf","method","headers","logout"],"sources":["C:/Users/komun/booking-app/frontend/src/auth.ts"],"sourcesContent":["// src/auth.ts\r\nexport type AuthResult = {\r\n  user: { id: number; email: string; name?: string | null; picture?: string | null };\r\n  tokens: { access_token: string; refresh_token: string; token_type: 'bearer' };\r\n};\r\n\r\nconst BASE =\r\n  (import.meta as any).env?.VITE_API_BASE ||\r\n  (window as any).__API_BASE__ ||\r\n  'http://127.0.0.1:8000';\r\n\r\n// прочети стойност на cookie по име\r\nfunction getCookie(name: string) {\r\n  const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-.$?*|{}()[\\]\\\\/+^]/g, '\\\\$&') + '=([^;]*)'));\r\n  return m ? decodeURIComponent(m[1]) : null;\r\n}\r\n\r\nexport async function openOAuthPopup(provider: 'google'): Promise<AuthResult> {\r\n  const w = 500, h = 650;\r\n  const left = window.screenX + (window.outerWidth - w) / 2;\r\n  const top = window.screenY + (window.outerHeight - h) / 2;\r\n\r\n  const popup = window.open(\r\n    `${BASE}/auth/login/${provider}?redirect=1`,\r\n    'oauth',\r\n    `width=${w},height=${h},left=${left},top=${top}`\r\n  );\r\n  if (!popup) throw new Error('Popup blocked');\r\n\r\n  return new Promise<AuthResult>((resolve, reject) => {\r\n    const timeout = setTimeout(() => {\r\n      window.removeEventListener('message', onMsg);\r\n      try { if (popup) popup.close(); } catch {}\r\n      reject(new Error('OAuth timed out'));\r\n    }, 120_000);\r\n\r\n    const tick = setInterval(() => {\r\n      if (popup.closed) {\r\n        clearInterval(tick);\r\n        clearTimeout(timeout);\r\n        window.removeEventListener('message', onMsg);\r\n        reject(new Error('Popup closed'));\r\n      }\r\n    }, 500);\r\n\r\n    function onMsg(ev: MessageEvent) {\r\n      const ok = ev?.data?.user?.email;\r\n      if (!ok) return;\r\n      clearInterval(tick);\r\n      clearTimeout(timeout);\r\n      window.removeEventListener('message', onMsg);\r\n      try { if (popup) popup.close(); } catch {}\r\n      resolve(ev.data as AuthResult);\r\n    }\r\n\r\n    window.addEventListener('message', onMsg);\r\n  });\r\n}\r\n\r\nexport async function fetchMe() {\r\n  const res = await fetch(`${BASE}/auth/me`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error('Invalid session');\r\n  return res.json();\r\n}\r\n\r\nexport async function refreshSession() {\r\n  const xsrf = getCookie('XSRF-TOKEN');\r\n  const res = await fetch(`${BASE}/auth/refresh`, {\r\n    method: 'POST',\r\n    credentials: 'include',\r\n    headers: xsrf ? { 'X-XSRF-TOKEN': xsrf } : {},\r\n  });\r\n  if (!res.ok) throw new Error('Refresh failed');\r\n  return res.json();\r\n}\r\n\r\nexport async function logout() {\r\n  const xsrf = getCookie('XSRF-TOKEN');\r\n  const res = await fetch(`${BASE}/auth/logout`, {\r\n    method: 'POST',\r\n    credentials: 'include',\r\n    headers: xsrf ? { 'X-XSRF-TOKEN': xsrf } : {},\r\n  });\r\n  if (!res.ok) throw new Error('Logout failed');\r\n  return res.json();\r\n}\r\n"],"mappings":"SAAA;AAMA,KAAM,CAAAA,IAAI,CACR,EAAAC,IAAA,CAACC,MAAM,CAACC,IAAI,CAASC,GAAG,UAAAH,IAAA,iBAAxBA,IAAA,CAA0BI,aAAa,GACtCC,MAAM,CAASC,YAAY,EAC5B,uBAAuB,CAEzB;AACA,QAAS,CAAAC,SAASA,CAACC,IAAY,CAAE,CAC/B,KAAM,CAAAC,CAAC,CAAGC,QAAQ,CAACC,MAAM,CAACC,KAAK,CAAC,GAAI,CAAAC,MAAM,CAAC,UAAU,CAAGL,IAAI,CAACM,OAAO,CAAC,uBAAuB,CAAE,MAAM,CAAC,CAAG,UAAU,CAAC,CAAC,CACpH,MAAO,CAAAL,CAAC,CAAGM,kBAAkB,CAACN,CAAC,CAAC,CAAC,CAAC,CAAC,CAAG,IAAI,CAC5C,CAEA,MAAO,eAAe,CAAAO,cAAcA,CAACC,QAAkB,CAAuB,CAC5E,KAAM,CAAAC,CAAC,CAAG,GAAG,CAAEC,CAAC,CAAG,GAAG,CACtB,KAAM,CAAAC,IAAI,CAAGf,MAAM,CAACgB,OAAO,CAAG,CAAChB,MAAM,CAACiB,UAAU,CAAGJ,CAAC,EAAI,CAAC,CACzD,KAAM,CAAAK,GAAG,CAAGlB,MAAM,CAACmB,OAAO,CAAG,CAACnB,MAAM,CAACoB,WAAW,CAAGN,CAAC,EAAI,CAAC,CAEzD,KAAM,CAAAO,KAAK,CAAGrB,MAAM,CAACsB,IAAI,CACvB,GAAG5B,IAAI,eAAekB,QAAQ,aAAa,CAC3C,OAAO,CACP,SAASC,CAAC,WAAWC,CAAC,SAASC,IAAI,QAAQG,GAAG,EAChD,CAAC,CACD,GAAI,CAACG,KAAK,CAAE,KAAM,IAAI,CAAAE,KAAK,CAAC,eAAe,CAAC,CAE5C,MAAO,IAAI,CAAAC,OAAO,CAAa,CAACC,OAAO,CAAEC,MAAM,GAAK,CAClD,KAAM,CAAAC,OAAO,CAAGC,UAAU,CAAC,IAAM,CAC/B5B,MAAM,CAAC6B,mBAAmB,CAAC,SAAS,CAAEC,KAAK,CAAC,CAC5C,GAAI,CAAE,GAAIT,KAAK,CAAEA,KAAK,CAACU,KAAK,CAAC,CAAC,CAAE,CAAE,KAAM,CAAC,CACzCL,MAAM,CAAC,GAAI,CAAAH,KAAK,CAAC,iBAAiB,CAAC,CAAC,CACtC,CAAC,CAAE,MAAO,CAAC,CAEX,KAAM,CAAAS,IAAI,CAAGC,WAAW,CAAC,IAAM,CAC7B,GAAIZ,KAAK,CAACa,MAAM,CAAE,CAChBC,aAAa,CAACH,IAAI,CAAC,CACnBI,YAAY,CAACT,OAAO,CAAC,CACrB3B,MAAM,CAAC6B,mBAAmB,CAAC,SAAS,CAAEC,KAAK,CAAC,CAC5CJ,MAAM,CAAC,GAAI,CAAAH,KAAK,CAAC,cAAc,CAAC,CAAC,CACnC,CACF,CAAC,CAAE,GAAG,CAAC,CAEP,QAAS,CAAAO,KAAKA,CAACO,EAAgB,CAAE,KAAAC,QAAA,CAAAC,aAAA,CAC/B,KAAM,CAAAC,EAAE,CAAGH,EAAE,SAAFA,EAAE,kBAAAC,QAAA,CAAFD,EAAE,CAAEI,IAAI,UAAAH,QAAA,kBAAAC,aAAA,CAARD,QAAA,CAAUI,IAAI,UAAAH,aAAA,iBAAdA,aAAA,CAAgBI,KAAK,CAChC,GAAI,CAACH,EAAE,CAAE,OACTL,aAAa,CAACH,IAAI,CAAC,CACnBI,YAAY,CAACT,OAAO,CAAC,CACrB3B,MAAM,CAAC6B,mBAAmB,CAAC,SAAS,CAAEC,KAAK,CAAC,CAC5C,GAAI,CAAE,GAAIT,KAAK,CAAEA,KAAK,CAACU,KAAK,CAAC,CAAC,CAAE,CAAE,KAAM,CAAC,CACzCN,OAAO,CAACY,EAAE,CAACI,IAAkB,CAAC,CAChC,CAEAzC,MAAM,CAAC4C,gBAAgB,CAAC,SAAS,CAAEd,KAAK,CAAC,CAC3C,CAAC,CAAC,CACJ,CAEA,MAAO,eAAe,CAAAe,OAAOA,CAAA,CAAG,CAC9B,KAAM,CAAAC,GAAG,CAAG,KAAM,CAAAC,KAAK,CAAC,GAAGrD,IAAI,UAAU,CAAE,CAAEsD,WAAW,CAAE,SAAU,CAAC,CAAC,CACtE,GAAI,CAACF,GAAG,CAACN,EAAE,CAAE,KAAM,IAAI,CAAAjB,KAAK,CAAC,iBAAiB,CAAC,CAC/C,MAAO,CAAAuB,GAAG,CAACG,IAAI,CAAC,CAAC,CACnB,CAEA,MAAO,eAAe,CAAAC,cAAcA,CAAA,CAAG,CACrC,KAAM,CAAAC,IAAI,CAAGjD,SAAS,CAAC,YAAY,CAAC,CACpC,KAAM,CAAA4C,GAAG,CAAG,KAAM,CAAAC,KAAK,CAAC,GAAGrD,IAAI,eAAe,CAAE,CAC9C0D,MAAM,CAAE,MAAM,CACdJ,WAAW,CAAE,SAAS,CACtBK,OAAO,CAAEF,IAAI,CAAG,CAAE,cAAc,CAAEA,IAAK,CAAC,CAAG,CAAC,CAC9C,CAAC,CAAC,CACF,GAAI,CAACL,GAAG,CAACN,EAAE,CAAE,KAAM,IAAI,CAAAjB,KAAK,CAAC,gBAAgB,CAAC,CAC9C,MAAO,CAAAuB,GAAG,CAACG,IAAI,CAAC,CAAC,CACnB,CAEA,MAAO,eAAe,CAAAK,MAAMA,CAAA,CAAG,CAC7B,KAAM,CAAAH,IAAI,CAAGjD,SAAS,CAAC,YAAY,CAAC,CACpC,KAAM,CAAA4C,GAAG,CAAG,KAAM,CAAAC,KAAK,CAAC,GAAGrD,IAAI,cAAc,CAAE,CAC7C0D,MAAM,CAAE,MAAM,CACdJ,WAAW,CAAE,SAAS,CACtBK,OAAO,CAAEF,IAAI,CAAG,CAAE,cAAc,CAAEA,IAAK,CAAC,CAAG,CAAC,CAC9C,CAAC,CAAC,CACF,GAAI,CAACL,GAAG,CAACN,EAAE,CAAE,KAAM,IAAI,CAAAjB,KAAK,CAAC,eAAe,CAAC,CAC7C,MAAO,CAAAuB,GAAG,CAACG,IAAI,CAAC,CAAC,CACnB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}