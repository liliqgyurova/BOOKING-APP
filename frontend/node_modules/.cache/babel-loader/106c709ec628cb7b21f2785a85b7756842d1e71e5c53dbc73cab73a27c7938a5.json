{"ast":null,"code":"// src/auth.ts\n\nconst BASE = 'http://127.0.0.1:8000';\nexport async function openOAuthPopup(provider) {\n  // 1) Отваряме попъпа СЕГА (синхронно), за да не бъде блокиран\n  const w = 500,\n    h = 650;\n  const left = window.screenX + (window.outerWidth - w) / 2;\n  const top = window.screenY + (window.outerHeight - h) / 2;\n  const popup = window.open('', 'oauth', `width=${w},height=${h},left=${left},top=${top}`);\n  if (!popup) throw new Error('Popup blocked');\n\n  // мини \"loading\" в попъпа\n  try {\n    popup.document.write(`<!doctype html><html><head><title>Signing in…</title>\n      <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/></head>\n      <body style=\"font-family:sans-serif;display:grid;place-items:center;height:100vh;\">\n        <div style=\"opacity:.7\">Loading…</div>\n      </body></html>`);\n    popup.document.close();\n  } catch {}\n\n  // 2) Вземаме auth_url и пренасочваме отворения попъп\n  const res = await fetch(`${BASE}/auth/login/${provider}`);\n  if (!res.ok) {\n    popup.close();\n    throw new Error('Failed to init OAuth (check backend/.env)');\n  }\n  const {\n    auth_url\n  } = await res.json();\n  popup.location.href = auth_url;\n\n  // 3) Чакаме postMessage от бекенда\n  return new Promise((resolve, reject) => {\n    const timeout = setTimeout(() => {\n      window.removeEventListener('message', onMsg);\n      try {\n        if (popup) popup.close();\n      } catch {}\n      reject(new Error('OAuth timed out'));\n    }, 120000);\n    const tick = setInterval(() => {\n      if (popup.closed) {\n        clearInterval(tick);\n        clearTimeout(timeout);\n        window.removeEventListener('message', onMsg);\n        reject(new Error('Popup closed'));\n      }\n    }, 500);\n    function onMsg(ev) {\n      var _ev$data, _ev$data$tokens;\n      // бекендът връща { user, tokens } с postMessage(*)\n      const ok = ev === null || ev === void 0 ? void 0 : (_ev$data = ev.data) === null || _ev$data === void 0 ? void 0 : (_ev$data$tokens = _ev$data.tokens) === null || _ev$data$tokens === void 0 ? void 0 : _ev$data$tokens.access_token;\n      if (!ok) return;\n      clearInterval(tick);\n      clearTimeout(timeout);\n      window.removeEventListener('message', onMsg);\n      try {\n        popup.close();\n      } catch {}\n      resolve(ev.data);\n    }\n    window.addEventListener('message', onMsg);\n  });\n}\nexport async function fetchMe(accessToken) {\n  const res = await fetch(`${BASE}/auth/me`, {\n    headers: {\n      Authorization: `Bearer ${accessToken}`\n    }\n  });\n  if (!res.ok) throw new Error('Invalid token');\n  return res.json();\n}","map":{"version":3,"names":["BASE","openOAuthPopup","provider","w","h","left","window","screenX","outerWidth","top","screenY","outerHeight","popup","open","Error","document","write","close","res","fetch","ok","auth_url","json","location","href","Promise","resolve","reject","timeout","setTimeout","removeEventListener","onMsg","tick","setInterval","closed","clearInterval","clearTimeout","ev","_ev$data","_ev$data$tokens","data","tokens","access_token","addEventListener","fetchMe","accessToken","headers","Authorization"],"sources":["C:/Users/komun/booking-app/frontend/src/auth.ts"],"sourcesContent":["// src/auth.ts\r\nexport type AuthResult = {\r\n  user: { id: number; email: string; name?: string | null; picture?: string | null };\r\n  tokens: { access_token: string; refresh_token: string; token_type: 'bearer' };\r\n};\r\n\r\nconst BASE = 'http://127.0.0.1:8000';\r\n\r\nexport async function openOAuthPopup(provider: 'google'): Promise<AuthResult> {\r\n  // 1) Отваряме попъпа СЕГА (синхронно), за да не бъде блокиран\r\n  const w = 500, h = 650;\r\n  const left = window.screenX + (window.outerWidth - w) / 2;\r\n  const top = window.screenY + (window.outerHeight - h) / 2;\r\n  const popup = window.open('', 'oauth', `width=${w},height=${h},left=${left},top=${top}`);\r\n  if (!popup) throw new Error('Popup blocked');\r\n\r\n  // мини \"loading\" в попъпа\r\n  try {\r\n    popup.document.write(`<!doctype html><html><head><title>Signing in…</title>\r\n      <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/></head>\r\n      <body style=\"font-family:sans-serif;display:grid;place-items:center;height:100vh;\">\r\n        <div style=\"opacity:.7\">Loading…</div>\r\n      </body></html>`);\r\n    popup.document.close();\r\n  } catch {}\r\n\r\n  // 2) Вземаме auth_url и пренасочваме отворения попъп\r\n  const res = await fetch(`${BASE}/auth/login/${provider}`);\r\n  if (!res.ok) {\r\n    popup.close();\r\n    throw new Error('Failed to init OAuth (check backend/.env)');\r\n  }\r\n  const { auth_url } = await res.json();\r\n  popup.location.href = auth_url;\r\n\r\n  // 3) Чакаме postMessage от бекенда\r\n  return new Promise<AuthResult>((resolve, reject) => {\r\n    const timeout = setTimeout(() => {\r\n      window.removeEventListener('message', onMsg);\r\n      try { if (popup) popup.close(); } catch {}\r\n      reject(new Error('OAuth timed out'));\r\n    }, 120_000);\r\n\r\n    const tick = setInterval(() => {\r\n      if (popup.closed) {\r\n        clearInterval(tick);\r\n        clearTimeout(timeout);\r\n        window.removeEventListener('message', onMsg);\r\n        reject(new Error('Popup closed'));\r\n      }\r\n    }, 500);\r\n\r\n    function onMsg(ev: MessageEvent) {\r\n      // бекендът връща { user, tokens } с postMessage(*)\r\n      const ok = ev?.data?.tokens?.access_token;\r\n      if (!ok) return;\r\n      clearInterval(tick);\r\n      clearTimeout(timeout);\r\n      window.removeEventListener('message', onMsg);\r\n      try { popup.close(); } catch {}\r\n      resolve(ev.data as AuthResult);\r\n    }\r\n\r\n    window.addEventListener('message', onMsg);\r\n  });\r\n}\r\n\r\nexport async function fetchMe(accessToken: string) {\r\n  const res = await fetch(`${BASE}/auth/me`, {\r\n    headers: { Authorization: `Bearer ${accessToken}` },\r\n  });\r\n  if (!res.ok) throw new Error('Invalid token');\r\n  return res.json();\r\n}\r\n"],"mappings":"AAAA;;AAMA,MAAMA,IAAI,GAAG,uBAAuB;AAEpC,OAAO,eAAeC,cAAcA,CAACC,QAAkB,EAAuB;EAC5E;EACA,MAAMC,CAAC,GAAG,GAAG;IAAEC,CAAC,GAAG,GAAG;EACtB,MAAMC,IAAI,GAAGC,MAAM,CAACC,OAAO,GAAG,CAACD,MAAM,CAACE,UAAU,GAAGL,CAAC,IAAI,CAAC;EACzD,MAAMM,GAAG,GAAGH,MAAM,CAACI,OAAO,GAAG,CAACJ,MAAM,CAACK,WAAW,GAAGP,CAAC,IAAI,CAAC;EACzD,MAAMQ,KAAK,GAAGN,MAAM,CAACO,IAAI,CAAC,EAAE,EAAE,OAAO,EAAE,SAASV,CAAC,WAAWC,CAAC,SAASC,IAAI,QAAQI,GAAG,EAAE,CAAC;EACxF,IAAI,CAACG,KAAK,EAAE,MAAM,IAAIE,KAAK,CAAC,eAAe,CAAC;;EAE5C;EACA,IAAI;IACFF,KAAK,CAACG,QAAQ,CAACC,KAAK,CAAC;AACzB;AACA;AACA;AACA,qBAAqB,CAAC;IAClBJ,KAAK,CAACG,QAAQ,CAACE,KAAK,CAAC,CAAC;EACxB,CAAC,CAAC,MAAM,CAAC;;EAET;EACA,MAAMC,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGnB,IAAI,eAAeE,QAAQ,EAAE,CAAC;EACzD,IAAI,CAACgB,GAAG,CAACE,EAAE,EAAE;IACXR,KAAK,CAACK,KAAK,CAAC,CAAC;IACb,MAAM,IAAIH,KAAK,CAAC,2CAA2C,CAAC;EAC9D;EACA,MAAM;IAAEO;EAAS,CAAC,GAAG,MAAMH,GAAG,CAACI,IAAI,CAAC,CAAC;EACrCV,KAAK,CAACW,QAAQ,CAACC,IAAI,GAAGH,QAAQ;;EAE9B;EACA,OAAO,IAAII,OAAO,CAAa,CAACC,OAAO,EAAEC,MAAM,KAAK;IAClD,MAAMC,OAAO,GAAGC,UAAU,CAAC,MAAM;MAC/BvB,MAAM,CAACwB,mBAAmB,CAAC,SAAS,EAAEC,KAAK,CAAC;MAC5C,IAAI;QAAE,IAAInB,KAAK,EAAEA,KAAK,CAACK,KAAK,CAAC,CAAC;MAAE,CAAC,CAAC,MAAM,CAAC;MACzCU,MAAM,CAAC,IAAIb,KAAK,CAAC,iBAAiB,CAAC,CAAC;IACtC,CAAC,EAAE,MAAO,CAAC;IAEX,MAAMkB,IAAI,GAAGC,WAAW,CAAC,MAAM;MAC7B,IAAIrB,KAAK,CAACsB,MAAM,EAAE;QAChBC,aAAa,CAACH,IAAI,CAAC;QACnBI,YAAY,CAACR,OAAO,CAAC;QACrBtB,MAAM,CAACwB,mBAAmB,CAAC,SAAS,EAAEC,KAAK,CAAC;QAC5CJ,MAAM,CAAC,IAAIb,KAAK,CAAC,cAAc,CAAC,CAAC;MACnC;IACF,CAAC,EAAE,GAAG,CAAC;IAEP,SAASiB,KAAKA,CAACM,EAAgB,EAAE;MAAA,IAAAC,QAAA,EAAAC,eAAA;MAC/B;MACA,MAAMnB,EAAE,GAAGiB,EAAE,aAAFA,EAAE,wBAAAC,QAAA,GAAFD,EAAE,CAAEG,IAAI,cAAAF,QAAA,wBAAAC,eAAA,GAARD,QAAA,CAAUG,MAAM,cAAAF,eAAA,uBAAhBA,eAAA,CAAkBG,YAAY;MACzC,IAAI,CAACtB,EAAE,EAAE;MACTe,aAAa,CAACH,IAAI,CAAC;MACnBI,YAAY,CAACR,OAAO,CAAC;MACrBtB,MAAM,CAACwB,mBAAmB,CAAC,SAAS,EAAEC,KAAK,CAAC;MAC5C,IAAI;QAAEnB,KAAK,CAACK,KAAK,CAAC,CAAC;MAAE,CAAC,CAAC,MAAM,CAAC;MAC9BS,OAAO,CAACW,EAAE,CAACG,IAAkB,CAAC;IAChC;IAEAlC,MAAM,CAACqC,gBAAgB,CAAC,SAAS,EAAEZ,KAAK,CAAC;EAC3C,CAAC,CAAC;AACJ;AAEA,OAAO,eAAea,OAAOA,CAACC,WAAmB,EAAE;EACjD,MAAM3B,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGnB,IAAI,UAAU,EAAE;IACzC8C,OAAO,EAAE;MAAEC,aAAa,EAAE,UAAUF,WAAW;IAAG;EACpD,CAAC,CAAC;EACF,IAAI,CAAC3B,GAAG,CAACE,EAAE,EAAE,MAAM,IAAIN,KAAK,CAAC,eAAe,CAAC;EAC7C,OAAOI,GAAG,CAACI,IAAI,CAAC,CAAC;AACnB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}